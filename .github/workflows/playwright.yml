name: Playwright Tests (V3)

on:
  workflow_dispatch:
    inputs:
      workers:
        description: "Workers (1..3)"
        required: true
        default: "2"
        type: choice
        options: ["1", "2", "3"]
      browser:
        description: "Browser project"
        required: true
        default: "chromium"
        type: choice
        options: [chromium, firefox, webkit]
      tag:
        description: "Tag/grep (free text). Examples: @product, @login, @cart, @regression, @all"
        required: true
        default: "@all"
        type: string

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # Allure generate needs Java
      - name: Setup Java (for Allure)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests (with inputs)
        env:
          WORKERS: ${{ inputs.workers }}
          BROWSER: ${{ inputs.browser }}
          TAG: ${{ inputs.tag }}
        run: |
          echo "Workers=$WORKERS | Browser=$BROWSER | Tag=$TAG"
          CMD="npx playwright test --workers=$WORKERS --project=$BROWSER"

          if [ "$TAG" = "@all" ] || [ -z "$TAG" ]; then
            echo "Run ALL tests (no grep)"
          else
            echo "Run with grep: $TAG"
            CMD="$CMD --grep \"$TAG\""
          fi

          echo "Running: $CMD"
          eval $CMD

      # 1) Bring previous history (trend) into current allure-results BEFORE generate
      - name: Restore Allure history (trending)
        if: always()
        run: |
          # sanitize tag => folder-safe
          SAFE_TAG=$(echo "${{ inputs.tag }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/_/g')
          echo "SAFE_TAG=$SAFE_TAG" >> $GITHUB_ENV

          HISTORY_SRC="docs/allure/latest/${{ inputs.browser }}/$SAFE_TAG/history"
          if [ -d "$HISTORY_SRC" ]; then
            echo "Found previous history at: $HISTORY_SRC"
            mkdir -p allure-results/history
            cp -R "$HISTORY_SRC/." allure-results/history/
          else
            echo "No previous history found (first run for this browser/tag)."
          fi

      # 2) Generate Allure HTML report (includes history if restored)
      - name: Generate Allure report
        if: always()
        run: npm run allure:generate

      # 3) Publish: latest overwrite + keep runs snapshot + landing pages
      - name: Publish Allure report to docs (latest + runs + history)
        if: always()
        run: |
          RUN_KEY="${{ github.run_number }}-${{ github.run_id }}"
          BROWSER="${{ inputs.browser }}"
          SAFE_TAG="${{ env.SAFE_TAG }}"

          # Ensure Jekyll is disabled
          mkdir -p docs
          touch docs/.nojekyll

          # Landing for root
          cat > docs/index.html << 'EOF'
          <!doctype html><meta charset="utf-8" />
          <title>Reports</title>
          <h1>Reports</h1>
          <ul>
            <li><a href="./allure/">Allure Reports</a></li>
          </ul>
          EOF

          # Landing for /allure (redirect to latest)
          mkdir -p docs/allure
          cat > docs/allure/index.html << 'EOF'
          <!doctype html><meta charset="utf-8" />
          <meta http-equiv="refresh" content="0; url=./latest/" />
          <title>Allure</title>
          <p>Redirecting to <a href="./latest/">latest</a>...</p>
          EOF

          # Latest per browser/tag (overwrite)
          LATEST_DIR="docs/allure/latest/$BROWSER/$SAFE_TAG"
          rm -rf "$LATEST_DIR"
          mkdir -p "$LATEST_DIR"
          cp -R allure-report/. "$LATEST_DIR/"

          # Snapshot per run (keep)
          RUN_DIR="docs/allure/runs/$RUN_KEY/$BROWSER/$SAFE_TAG"
          rm -rf "$RUN_DIR"
          mkdir -p "$RUN_DIR"
          cp -R allure-report/. "$RUN_DIR/"

          # Optional: keep a small HTML pointer to current run
          cat > docs/allure/latest/$BROWSER/$SAFE_TAG/_run.html << EOF
          <!doctype html><meta charset="utf-8" />
          <p>Run: <a href="../../../runs/$RUN_KEY/$BROWSER/$SAFE_TAG/">$RUN_KEY</a></p>
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git commit -m "Publish Allure report ($RUN_KEY) [$BROWSER][$SAFE_TAG]" || echo "Nothing to commit"
          git push origin HEAD:v3_cicd_github

          # Build runs index (list latest runs on top)
          RUNS_INDEX="docs/allure/runs/index.html"
          mkdir -p docs/allure/runs

          echo '<!doctype html><meta charset="utf-8">' > $RUNS_INDEX
          echo '<title>Allure Runs</title>' >> $RUNS_INDEX
          echo '<h1>Allure – Test Runs</h1>' >> $RUNS_INDEX
          echo '<p><a href="../latest/">← Back to Latest</a></p>' >> $RUNS_INDEX
          echo '<ul>' >> $RUNS_INDEX

          # List runs (newest first)
          for d in $(ls -1 docs/allure/runs | sort -r); do
            if [ "$d" != "index.html" ]; then
              echo "  <li><a href=\"./$d/\">Run $d</a></li>" >> $RUNS_INDEX
            fi
          done

          echo '</ul>' >> $RUNS_INDEX

      # Artifacts (optional but useful)
      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.browser }}-${{ inputs.tag }}
          path: playwright-report
          retention-days: 7

      - name: Upload Allure report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ inputs.browser }}-${{ inputs.tag }}
          path: allure-report
          retention-days: 7

      - name: Upload Allure results (raw)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ inputs.browser }}-${{ inputs.tag }}
          path: allure-results
          retention-days: 7
