name: Playwright Tests (V3)

on:
  workflow_dispatch:
    inputs:
      workers:
        description: "Workers (1..3)"
        required: true
        default: "2"
        type: choice
        options: ["1", "2", "3"]
      browser:
        description: "Browser project"
        required: true
        default: "chromium"
        type: choice
        options: [chromium, firefox, webkit]
      tag:
        description: "Tag/grep (free text). Examples: @product, @login, @cart, @regression, @all"
        required: true
        default: "@demo"
        type: string

permissions:
  contents: write

jobs:
  test:
    concurrency:
      group: gh-pages-publish
      cancel-in-progress: false
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Java (for Allure)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests (with inputs)
        env:
          WORKERS: ${{ inputs.workers }}
          BROWSER: ${{ inputs.browser }}
          TAG: ${{ inputs.tag }}
        run: |
          echo "Workers=$WORKERS | Browser=$BROWSER | Tag=$TAG"
          CMD="npx playwright test --workers=$WORKERS --project=$BROWSER"

          if [ "$TAG" = "@all" ] || [ -z "$TAG" ]; then
            echo "Run ALL tests (no grep)"
          else
            echo "Run with grep: $TAG"
            CMD="$CMD --grep \"$TAG\""
          fi

          echo "Running: $CMD"
          eval $CMD

      # Checkout gh-pages so we can restore history + publish into the correct folder (site/)
      - name: Checkout gh-pages (report branch)
        if: always()
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: site
          fetch-depth: 0

      - name: Prepare SAFE_TAG
        if: always()
        env:
          TAG: ${{ inputs.tag }}
        run: |
          SAFE_TAG=$(echo "$TAG" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's/^[@#]\+//; s/[^a-z0-9._-]/_/g; s/^_+//')
          [ -z "$SAFE_TAG" ] && SAFE_TAG=all
          echo "SAFE_TAG=$SAFE_TAG" >> $GITHUB_ENV
          echo "SAFE_TAG=$SAFE_TAG"

      # Restore history from gh-pages (site/) into allure-results BEFORE generating report
      - name: Restore Allure history (trending)
        if: always()
        env:
          BROWSER: ${{ inputs.browser }}
        run: |
          HISTORY_SRC="site/docs/allure/latest/$BROWSER/history"
          if [ -d "$HISTORY_SRC" ]; then
            echo "Found previous history at: $HISTORY_SRC"
            mkdir -p allure-results/history
            cp -R "$HISTORY_SRC/." allure-results/history/
          else
            echo "No previous history found (first run for this browser)."
          fi

      - name: Generate Allure report
        if: always()
        run: npm run allure:generate

      # Artifacts (optional)
      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.browser }}-${{ inputs.tag }}
          path: playwright-report
          retention-days: 7

      - name: Upload Allure report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ inputs.browser }}-${{ inputs.tag }}
          path: allure-report
          retention-days: 7

      - name: Upload Allure results (raw)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ inputs.browser }}-${{ inputs.tag }}
          path: allure-results
          retention-days: 7

      - name: Publish Allure report (latest + runs + index + cleanup)
        if: always()
        env:
          TAG: ${{ inputs.tag }}
          BROWSER: ${{ inputs.browser }}
          SAFE_TAG: ${{ env.SAFE_TAG }}
        run: |
          set -e

          KEEP_RUNS=20
          RUN_KEY="${{ github.run_number }}-${{ github.run_id }}"

          SITE_DIR="site"
          RUNS_ROOT="$SITE_DIR/docs/allure/runs"
          #---- LATEST_DIR="$SITE_DIR/docs/allure/latest/$BROWSER/$SAFE_TAG"
          #---- RUN_DIR="$RUNS_ROOT/$RUN_KEY/$BROWSER/$SAFE_TAG"

          LATEST_DIR="$SITE_DIR/docs/allure/latest/$BROWSER"
          RUN_DIR="$RUNS_ROOT/$RUN_KEY/$BROWSER"


          # ---- go to gh-pages repo clone ----
          cd "$SITE_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ---- SYNC FIRST (important) ----
          git fetch origin gh-pages
          git checkout -B gh-pages origin/gh-pages
          git reset --hard origin/gh-pages

          # ---- back to workspace root to copy generated report ----
          cd -

          mkdir -p "$LATEST_DIR" "$RUN_DIR" "$RUNS_ROOT"

          # ---- latest overwrite ----
          rm -rf "$LATEST_DIR"
          mkdir -p "$LATEST_DIR"
          cp -R allure-report/. "$LATEST_DIR/"

          # ---- snapshot run ----
          rm -rf "$RUN_DIR"
          mkdir -p "$RUN_DIR"
          cp -R allure-report/. "$RUN_DIR/"

          # ---- cleanup runs: keep last N RUN_KEY folders ----
          cd "$RUNS_ROOT"
          ls -1dt */ 2>/dev/null | tail -n +$((KEEP_RUNS+1)) | xargs -r rm -rf
          cd - >/dev/null

          # ---- build runs/index.html ----
          {
            echo '<!doctype html><meta charset="utf-8">'
            echo '<title>Allure Runs</title>'
            echo '<h1>Allure Runs (latest first)</h1>'
            echo '<p><a href="../">Back</a> | <a href="../latest/">Latest</a></p>'
            echo '<ul>'
            for d in $(ls -1dt "$RUNS_ROOT"/*/ 2>/dev/null | head -n $KEEP_RUNS); do
              run=$(basename "$d")
              echo "<li><a href=\"./$run/$BROWSER/\">$run</a></li>"
            done
            echo '</ul>'
          } > "$RUNS_ROOT/index.html"

          # ---- root landing pages ----
          mkdir -p "$SITE_DIR/docs/allure"
          touch "$SITE_DIR/docs/.nojekyll"

          cat > "$SITE_DIR/docs/index.html" << 'EOF'
          <!doctype html><meta charset="utf-8">
          <title>Reports</title>
          <h1>Reports</h1>
          <ul>
            <li><a href="./allure/">Allure Reports</a></li>
          </ul>
          EOF

          cat > "$SITE_DIR/docs/allure/index.html" << 'EOF'
          <!doctype html><meta charset="utf-8">
          <title>Allure Reports</title>
          <h1>Allure Reports</h1>
          <p><a href="./latest/">Latest</a> | <a href="./runs/">Runs</a></p>
          EOF

          # Create landing index for each run key (avoid 404)
          cat > "$RUNS_ROOT/$RUN_KEY/index.html" << EOF
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=./$BROWSER/$SAFE_TAG/">
          <title>Allure Run $RUN_KEY</title>
          <p>Redirecting to <a href="./$BROWSER/$SAFE_TAG/">report</a>...</p>
          EOF

          # landing for latest/
          cat > "$SITE_DIR/docs/allure/latest/index.html" << EOF
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=./$BROWSER/$SAFE_TAG/">
          <title>Latest Allure</title>
          <p>Redirecting to <a href="./$BROWSER/$SAFE_TAG/">latest</a>...</p>
          EOF

          # landing for each run key/
          cat > "$RUNS_ROOT/$RUN_KEY/index.html" << EOF
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=./$BROWSER/$SAFE_TAG/">
          <title>Allure Run $RUN_KEY</title>
          <p>Redirecting to <a href="./$BROWSER/$SAFE_TAG/">run</a>...</p>
          EOF

          # landing for /latest/
          cat > "$SITE_DIR/docs/allure/latest/index.html" << EOF
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=./$BROWSER/">
          <title>Latest Allure</title>
          <p>Redirecting to <a href="./$BROWSER/">latest</a>...</p>
          EOF

          # landing for /runs/<RUN_KEY>/
          cat > "$RUNS_ROOT/$RUN_KEY/index.html" << EOF
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=./$BROWSER/">
          <title>Allure Run $RUN_KEY</title>
          <p>Redirecting to <a href="./$BROWSER/">run</a>...</p>
          EOF



          # ---- commit & push ----
          cd "$SITE_DIR"
          git add docs
          git commit -m "Publish Allure report ($RUN_KEY) [$BROWSER][$SAFE_TAG]" || echo "Nothing to commit"

          # Option A (recommended for generated branch): force-with-lease to avoid non-fast-forward
          git push --force-with-lease origin gh-pages
